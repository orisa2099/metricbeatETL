input {
  beats {
    port => 5044
  }
}

filter {
  # Handle network metrics
  if [event][dataset] == "system.network" {
    mutate {
      add_field => {
        "[metrics][network.in.bytes]"  => "%{[system][network][in][bytes]}"
        "[metrics][network.out.bytes]" => "%{[system][network][out][bytes]}"
      }
    }

    mutate {
      convert => {
        "[metrics][network.in.bytes]"  => "integer"
        "[metrics][network.out.bytes]" => "integer"
      }
    }
  }

  # Handle process metrics
  if [event][dataset] == "system.process" {
    mutate {
      add_field => {
        "[metrics][process.cpu.pct]" => "%{[system][process][cpu][total][norm][pct]}"
        "[metrics][process.memory.pct]" => "%{[system][process][memory][rss][pct]}"
      }
    }

    mutate {
      convert => {
        "[metrics][process.cpu.pct]" => "float"
        "[metrics][process.memory.pct]" => "float"
      }
    }
  }
}

output {
  # Network IN bytes
  if [metrics][network.in.bytes] {
    jdbc {
      driver_jar_path => "/usr/share/logstash/jdbc/postgresql-42.7.2.jar"
      driver_class => "org.postgresql.Driver"
      connection_string => "jdbc:postgresql://postgres:5432/metricsdb"
      username => "metricsuser"
      password => "metricspassword"

      statement => [
        "INSERT INTO metricbeat.metric_samples (event_time, host, module, metricset, metric_name, metric_value, raw_event)
         VALUES (CAST(? AS TIMESTAMP), ?, ?, ?, ?, ?, ?::json)",
        "@timestamp",
        "[host][name]",
        "[event][module]",
        "[metricset][name]",
        "network.in.bytes",
        "[metrics][network.in.bytes]",
        "message"
      ]
    }
  }

  # Network OUT bytes
  if [metrics][network.out.bytes] {
    jdbc {
      driver_jar_path => "/usr/share/logstash/jdbc/postgresql-42.7.2.jar"
      driver_class => "org.postgresql.Driver"
      connection_string => "jdbc:postgresql://postgres:5432/metricsdb"
      username => "metricsuser"
      password => "metricspassword"

      statement => [
        "INSERT INTO metricbeat.metric_samples (event_time, host, module, metricset, metric_name, metric_value, raw_event)
         VALUES (CAST(? AS TIMESTAMP), ?, ?, ?, ?, ?, ?::json)",
        "@timestamp",
        "[host][name]",
        "[event][module]",
        "[metricset][name]",
        "network.out.bytes",
        "[metrics][network.out.bytes]",
        "message"
      ]
    }
  }

  # Process CPU percentage
  if [metrics][process.cpu.pct] {
    jdbc {
      driver_jar_path => "/usr/share/logstash/jdbc/postgresql-42.7.2.jar"
      driver_class => "org.postgresql.Driver"
      connection_string => "jdbc:postgresql://postgres:5432/metricsdb"
      username => "metricsuser"
      password => "metricspassword"

      statement => [
        "INSERT INTO metricbeat.metric_samples (event_time, host, module, metricset, metric_name, metric_value, raw_event)
         VALUES (CAST(? AS TIMESTAMP), ?, ?, ?, ?, ?, ?::json)",
        "@timestamp",
        "[host][name]",
        "[event][module]",
        "[metricset][name]",
        "process.cpu.pct",
        "[metrics][process.cpu.pct]",
        "message"
      ]
    }
  }

  # Debug output (optional, comment out in production)
 # stdout { codec => rubydebug { metadata => true } }
}